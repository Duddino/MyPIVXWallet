<script setup>
import { COIN, cChainParams } from '../chain_params';
import { useSettings } from '../composables/use_settings';
import { useWallet } from '../composables/use_wallet';
import Activity from '../dashboard/Activity.vue';
import RestoreWallet from '../dashboard/RestoreWallet.vue';
import { Database } from '../database';
import { getEventEmitter } from '../event_bus';
import { getNetwork } from '../network';
import StakeBalance from './StakeBalance.vue';
import StakeInput from './StakeInput.vue';
import { onMounted, ref, watch } from 'vue';
const wallet = useWallet();
const {
    balance,
    coldBalance,
    createAndSendTransaction,
    getAddress,
    price,
    currency,
} = wallet;
const { advancedMode, displayDecimals } = useSettings();
const showUnstake = ref(false);
const showStake = ref(false);
const coldStakingAddress = ref('');
const stakeAmount = ref('');
const unstakeAmount = ref('');
const showRestoreWallet = ref(false);
const restoreWalletReason = ref('');
async function updateColdStakingAddress() {
    const db = await Database.getInstance();
    coldStakingAddress.value =
        (await db.getAccount())?.coldAddress ||
        cChainParams.current.defaultColdStakingAddress;
}
getEventEmitter().on('toggle-network', updateColdStakingAddress);
onMounted(updateColdStakingAddress);

watch(coldStakingAddress, async (coldStakingAddress) => {
    const db = await Database.getInstance();
    const cAccount = await db.getAccount();
    if (!cAccount) return;

    // Save to DB (allowDeletion enabled to allow for resetting the Cold Address)
    cAccount.coldAddress = coldStakingAddress;
    await db.updateAccount(cAccount, true);
});
async function stake(value, ownerAddress) {
    await restoreWallet();
    createAndSendTransaction(getNetwork(), coldStakingAddress.value, value, {
        isDelegation: true,
        returnAddress: ownerAddress,
    });
}

async function unstake(value) {
    await restoreWallet();
    createAndSendTransaction(getNetwork(), getAddress(1), value, {
        useDelegatedInputs: true,
        delegateChange: true,
        changeDelegationAddress: coldStakingAddress.value,
    });
}

async function restoreWallet(strReason) {
    if (!wallet.isEncrypted.value) return false;
    if (wallet.isHardwareWallet.value) return true;
    showRestoreWallet.value = true;
    return await new Promise((res) => {
        watch(
            showRestoreWallet,
            () => {
                res(wallet.isEncrypted.value);
            },
            { once: true }
        );
    });
}

async function importWif(wif, extsk) {
    const secret = await ParsedSecret.parse(wif);
    if (secret.masterKey) {
        await wallet.setMasterKey(secret.masterKey);
        if (wallet.hasShield.value && !extsk) {
            createAlert(
                'warning',
                'Could not decrypt sk even if password is correct, please contact a developer'
            );
        }
        if (wallet.hasShield.value) {
            await wallet.setExtsk(extsk);
        }
        createAlert('success', ALERTS.WALLET_UNLOCKED, 1500);
    }
}
</script>

<template>
    <div class="row p-0">
        <div class="col-12 p-0 mb-5">
            <center>
                <StakeBalance
                    v-model:coldStakingAddress="coldStakingAddress"
                    :coldBalance="coldBalance"
                    :price="price"
                    :currency="currency"
                    :displayDecimals="displayDecimals"
                    @showUnstake="showUnstake = true"
                    @showStake="showStake = true"
                />
            </center>
        </div>

        <div class="col-12 mb-5">
            <Activity title="Reward History" :rewards="true" />
        </div>
    </div>
    <StakeInput
        :unstake="false"
        :showOwnerAddress="advancedMode"
        :show="showStake"
        :price="price"
        v-model:amount="stakeAmount"
        @maxBalance="stakeAmount = (balance / COIN).toString()"
        @close="showStake = false"
        @submit="stake"
    />
    <StakeInput
        :unstake="true"
        :showOwnerAddress="false"
        :show="showUnstake"
        :price="price"
        v-model:amount="unstakeAmount"
        @maxBalance="unstakeAmount = (coldBalance / COIN).toString()"
        @close="showUnstake = false"
        @submit="unstake"
    />
    <RestoreWallet
        :show="showRestoreWallet"
        :reason="restoreWalletReason"
        @close="showRestoreWallet = false"
        @import="importWif"
    />
</template>
